---
permalink: upgrade/task_refresh_4n_mcc_ip.html
sidebar: sidebar
keywords: metrocluster, upgrade, refresh, four, node, ip, configuration, add, autosupport
summary: 'Beginning with ONTAP 9.8, you can upgrade the controllers and storage in a four-node MetroCluster IP configuration by expanding the configuration to become a temporary eight-node configuration and then removing the old disaster recovery (DR) group.'
---
= Refreshing a four-node or an eight-node MetroCluster IP configuration (ONTAP 9.8 and later)
:icons: font
:imagesdir: ../media/

[.lead]
Beginning with ONTAP 9.13.1, you can upgrade the controllers and storage in an eight-node MetroCluster IP configuration by expanding the configuration to become a temporary twelve-node configuration and then removing the old DR groups.

Beginning with ONTAP 9.8, you can upgrade the controllers and storage in a four-node MetroCluster IP configuration by expanding the configuration to become a temporary eight-node configuration and then removing the old disaster recovery (DR) group.

.About this task

* If you have a four-node configuration, your system must be running ONTAP 9.8 or later.
* If you have an eight-node configuration, your system must be running ONTAP 9.13.1 or later.
* If you are upgrading the IP switches, they must be upgraded before to performing this refresh procedure.
* This procedure describes the steps required to refresh one four-node DR group. If you have an eight-node configuration (two DR groups) and you want to refresh both DR groups, you must repeat the entire procedure for the second DR group.
* References to "old nodes" mean the nodes that you intend to replace.
* If you have an eight-node configuration, you can refresh one or both DR groups. 
+
If you refresh both DR groups, you must refresh one DR group at a time. 
* For eight-node configurations, the source and target eight-node MetroCluster platform combination must be supported. 
+
NOTE: If you refresh both DR groups, the platform combination might not be supported after you refresh the first DR group. You must refresh both DR groups to achieve a supported eight-node configuration.
* You can only refresh specific platform models using this procedure in a MetroCluster IP configuration. 
** For information on what platform upgrade combinations are supported review the MetroCluster IP refresh table in  link:../upgrade/concept_choosing_tech_refresh_mcc.html#supported-metrocluster-ip-tech-refresh-combinations[Choosing a system refresh method].
* The lower limits of the source and target platform apply. If you transition to a higher platform, the limits of the new platform applies only after the tech refresh of all DR groups is completed.
* If you perform a tech refresh to a platform with lower limits than the source platform, you must adjust and reduce the limits to be at, or below, the target platform limits before performing this procedure. 

.Steps

. Gather information from the old nodes.
+
At this stage, the four-node configuration appears as shown in the following image:
+
image::../media/mcc_dr_group_a.png[]
+
The eight-node configuration appears as shown in the following image:
+
image::../media/mcc_dr_groups_8_node.gif[]

. To prevent automatic support case generation, send an AutoSupport message to indicate the upgrade is underway.
.. Issue the following command:
 +
`system node autosupport invoke -node * -type all -message "MAINT=10h Upgrading _old-model_ to _new-model"_`
+
The following example specifies a 10 hour maintenance window. You might want to allow additional time depending on your plan.
+
If the maintenance is completed before the time has elapsed, you can invoke an AutoSupport message indicating the end of the maintenance period:
+
`system node autosupport invoke -node * -type all -message MAINT=end`

.. Repeat the command on the partner cluster.
. Remove the existing MetroCluster configuration from Tiebreaker, Mediator, or other software that can initiate switchover.
+
[cols=2*]

|===

h| If you are using... h| Use this procedure...

a|
Tiebreaker
a|
link:../tiebreaker/concept_configuring_the_tiebreaker_software.html#commands-for-modifying-metrocluster-tiebreaker-configurations[Removing MetroCluster Configurations] in the _MetroCluster Tiebreaker Installation and Configuration Guide_
a|
Mediator
a|
Issue the following command from the ONTAP prompt:

`metrocluster configuration-settings mediator remove`
a|
Third-party applications
a|
Refer to the product documentation.
|===

. Perform all of the steps in link:../upgrade/task_expand_a_four_node_mcc_ip_configuration.html[Expanding a MetroCluster IP configuration] to add the new nodes and storage to the configuration.
+
When the expansion procedure is complete, the temporary configuration appears as shown in the following images:
+
.Temporary eight-node configuration
+
image::../media/mcc_dr_group_b.png[]
+
.Temporary twelve-node configuration
+
image::../media/mcc_dr_group_c4.png[]

. Move the CRS volumes.
+
Perform the steps in link:../maintain/task_move_a_metadata_volume_in_mcc_configurations.html[Moving a metadata volume in MetroCluster configurations].

. Move the data from the old nodes to new nodes using the following procedures in https://docs.netapp.com/platstor/topic/com.netapp.doc.hw-upgrade-controller/home.html[Other platform procedures: Controller Hardware Upgrade Express Guide^]

.. Perform all the steps in http://docs.netapp.com/platstor/topic/com.netapp.doc.hw-upgrade-controller/GUID-AFE432F6-60AD-4A79-86C0-C7D12957FA63.html[Creating an aggregate and moving volumes to the new nodes^].
+
NOTE: You might choose to mirror the aggregate when or after it is created.
 .. Perform all the steps in http://docs.netapp.com/platstor/topic/com.netapp.doc.hw-upgrade-controller/GUID-95CA9262-327D-431D-81AA-C73DEFF3DEE2.html[Moving non-SAN data LIFs and cluster management LIFs to the new nodes].

. Follow the steps in the procedure for removing the old DR group or groups.
+
link:concept_removing_a_disaster_recovery_group.html[Removing a Disaster Recovery group]
+
. If you want to refresh both DR groups in an eight-node configuration, you must repeat the entire procedure for each of the DR groups.
+
After you have removed the old DR group or groups, the configuration appears as shown in the following images:
+
.Four-node configuration
image::../media/mcc_dr_group_d.png[]
+
.Eight-node configuration
+
image::../media/mcc_dr_group_c5.png[]


. Confirm the operational mode of the MetroCluster configuration and perform a MetroCluster check.
.. Confirm the MetroCluster configuration and that the operational mode is normal:
+
`metrocluster show`

.. Confirm that all expected nodes are shown:
+
`metrocluster node show`

.. Issue the following command:
+
`metrocluster check run`

.. Display the results of the MetroCluster check:
+
`metrocluster check show`

. Restore monitoring if necessary, using the procedure for your configuration.
+
[cols=2*]

|===

h| If you are using... h| Use this procedure

a|
Tiebreaker
a|
link:../tiebreaker/concept_configuring_the_tiebreaker_software.html#adding-metrocluster-configurations[Adding MetroCluster configurations] in the _MetroCluster Tiebreaker Installation and Configuration_.
a|
Mediator
a|
link:../install-ip/concept_mediator_requirements.html
[Configuring the ONTAP Mediator service from a MetroCluster IP configuration] in the _MetroCluster IP Installation and Configuration_.
a|
Third-party applications
a|
Refer to the product documentation.
|===

. To resume automatic support case generation, send an Autosupport message to indicate that the maintenance is complete.
.. Issue the following command:
+
`system node autosupport invoke -node * -type all -message MAINT=end`
.. Repeat the command on the partner cluster.

// BURT 1374268, 21 APR 2021
// BURT 1448684, 02 FEB 2022
// 14 Apr 2023, BURT 1546321